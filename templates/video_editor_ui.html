<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>AI Video Gen - Video Editor</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght @400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
        }
        body {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* === demoai/editor.css から移植したスタイル === */
        .frame-card {
          position: relative;
          aspect-ratio: 16 / 9;
          background-size: cover;
          background-position: center;
          border-radius: 0.5rem;
          cursor: pointer;
          border: 3px solid transparent;
          transition: all 0.3s ease;
          overflow: hidden;
        }

        .frame-card:hover {
          transform: scale(1.05);
          box-shadow: 0 8px 16px rgba(52, 211, 153, 0.3);
        }

        .frame-card.selected {
          border-color: #34D399;
          box-shadow: 0 0 0 2px #34D399, 0 8px 20px rgba(52, 211, 153, 0.5);
        }

        .frame-card.edited::after {
          content: '✓ Edited';
          position: absolute;
          top: 8px;
          right: 8px;
          background: #34D399;
          color: black;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 11px;
          font-weight: bold;
        }

        .frame-number {
          position: absolute;
          bottom: 8px;
          left: 8px;
          background: rgba(0, 0, 0, 0.7);
          color: white;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: 600;
        }
        /* === ここまでが移植したスタイル === */


        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .video-player {
            aspect-ratio: 16/9;
        }
        .generated-image-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        .generated-image {
            aspect-ratio: 16/9;
            background-size: cover;
            background-position: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .generated-image:hover {
            border-color: #34D399;
            transform: scale(1.02);
        }
        .generated-image.selected {
            border-color: #34D399;
            box-shadow: 0 0 0 4px rgba(52, 211, 153, 0.2);
        }
        .upload-zone {
            border: 3px dashed #374151;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .upload-zone:hover {
            border-color: #34D399;
            background-color: rgba(52, 211, 153, 0.05);
        }
        .upload-zone.drag-over {
            border-color: #34D399;
            background-color: rgba(52, 211, 153, 0.1);
        }
    </style>
</head>
<body class="bg-background-dark text-white">
<div class="relative flex h-screen min-h-screen w-full flex-col bg-[#0a0a0a]">
    <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[#374151] px-6 py-3">
        <div class="flex items-center gap-4 text-white">
            <div class="size-6 text-[#34D399]">
                <svg fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.003 3.001a9 9 0 0 0-8.25 5.25H2v1.5h3.005a9 9 0 0 0-1.255 3.75H2v1.5h1.75a9 9 0 0 0 16.5 0H22v-1.5h-1.75a9 9 0 0 0-1.255-3.75H22v-1.5h-1.753A9 9 0 0 0 12.003 3.001Zm0 1.5a7.5 7.5 0 0 1 6.848 4.5H5.155a7.5 7.5 0 0 1 6.848-4.5ZM3.753 10.5a7.502 7.502 0 0 1 1.222-3.665l4.316 4.316-2.583.923a.75.75 0 0 0-.583 1.09l.001.002.75 2.1a7.5 7.5 0 0 1-3.123-4.766Zm15.272 3.664a7.502 7.502 0 0 1-1.222 3.666L13.5 13.513l2.583-.923a.75.75 0 0 0 .583-1.09l-.001-.002-.75-2.1a7.5 7.5 0 0 1 3.123 4.766Zm-5.34-1.127-3.75-1.34-1.34 3.75 3.75 1.34 1.34-3.75Z"></path>
                </svg>
            </div>
            <h2 class="text-white text-lg font-bold">AI Video Gen - Editor</h2>
        </div>
        <div class="flex flex-1 justify-center gap-8">
            <a class="text-gray-300 text-sm font-medium" href="#">Video Frame Editor</a>
        </div>
        <div class="flex items-center gap-2">
            <button id="export-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#34D399] text-black text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="material-symbols-outlined mr-2 !text-base">download</span>
                Export
            </button>
            <button id="save-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#374151] text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-[#4b5563] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="material-symbols-outlined mr-2 !text-base">save</span>
                Save
            </button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden">
        <div class="flex-1 flex flex-col p-6 items-center justify-center">
            <div class="w-full max-w-5xl">
                <div id="upload-section" class="block">
                    <div class="upload-zone" id="upload-zone">
                        <span class="material-symbols-outlined block text-6xl text-[#34D399] mb-4">movie</span>
                        <h3 class="text-xl font-bold text-white mb-2">Upload Your Video</h3>
                        <p class="text-gray-400 mb-4">Drag and drop your video here or click to select</p>
                        <p class="text-sm text-gray-500">Supported: MP4, MOV, AVI (Max 500MB)</p>
                        <input type="file" id="video-input" accept="video/*" class="hidden" />
                    </div>
                    <div id="upload-progress" class="mt-6 hidden">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-sm font-medium text-gray-300">Uploading...</p>
                            <p id="upload-percent" class="text-sm font-medium text-gray-300">0%</p>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="upload-progress-bar" class="bg-[#34D399] h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div id="player-section" class="hidden">
                    <div class="rounded-xl overflow-hidden bg-black mb-6 relative video-player flex items-center justify-center">
                        <video id="video-player" class="w-full h-full" controls>
                            <source id="video-source" type="video/mp4">
                        </video>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-white text-lg font-bold">Video Frames</h3>
                            <button id="reset-video-btn" class="text-sm text-gray-300 hover:text-[#34D399] transition-colors">
                                Upload New Video
                            </button>
                        </div>
                        <div id="frames-container" class="grid grid-cols-6 gap-4">
                            </div>
                    </div>
                    </div>
            </div>
        </div>

        <aside id="edit-panel" class="w-[420px] flex-shrink-0 bg-[#1a1a1a] border-l border-[#374151] flex flex-col hidden">
            <div class="p-4 border-b border-[#374151]">
                <button class="flex w-full min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-[#34D399] text-black gap-2 text-base font-bold leading-normal tracking-[0.015em]">
                    <span class="material-symbols-outlined !text-2xl">add_photo_alternate</span>
                    <span class="truncate">Edit Frame</span>
                </button>
            </div>

            <div class="flex-1 flex flex-col p-4 overflow-y-auto">
                <div id="selected-frame-info" class="flex items-center gap-3 mb-4 pb-4 border-b border-[#374151]">
                    <div id="selected-frame-thumb" class="w-24 h-14 bg-cover bg-center rounded-md bg-gray-700"></div>
                    <div class="flex-1">
                        <h4 class="text-white text-sm font-bold">Current Frame</h4>
                        <p id="frame-timestamp" class="text-gray-400 text-xs">Timestamp: 0:00</p>
                    </div>
                </div>

                <div id="chat-container" class="space-y-4 flex-1 overflow-y-auto">
                    </div>
            </div>

            <div class="p-4 border-t border-[#374151]">
                <div class="relative">
                    <input id="chat-input" class="w-full h-12 bg-[#374151] text-gray-300 placeholder-gray-500 rounded-lg pl-4 pr-12 border-2 border-transparent focus:border-[#34D399] focus:ring-0 transition-colors" placeholder="Describe the edit you want..."/>
                    <button id="send-btn" class="absolute right-2 top-1/2 -translate-y-1.2 flex items-center justify-center size-8 bg-[#34D399] rounded-md text-black hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="material-symbols-outlined !text-xl">arrow_upward</span>
                    </button>
                </div>
            </div>
        </aside>
    </main>
</div>

<script>
    // ==================== グローバル変数 ====================
    const state = {
        videoPath: null,
        frames: [],
        selectedFrame: null,
        selectedGeneratedImage: null,
        editedFrames: {},
        isProcessing: false
    };

    // ==================== DOM要素 ====================
    const uploadZone = document.getElementById('upload-zone');
    const videoInput = document.getElementById('video-input');
    const uploadSection = document.getElementById('upload-section');
    const playerSection = document.getElementById('player-section');
    const editPanel = document.getElementById('edit-panel');
    const framesContainer = document.getElementById('frames-container');
    const chatContainer = document.getElementById('chat-container');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const exportBtn = document.getElementById('export-btn');
    const saveBtn = document.getElementById('save-btn');
    const videoPlayer = document.getElementById('video-player');
    const videoSource = document.getElementById('video-source');
    const selectedFrameThumb = document.getElementById('selected-frame-thumb');
    const frameTimestamp = document.getElementById('frame-timestamp');
    const resetVideoBtn = document.getElementById('reset-video-btn');
    const uploadProgress = document.getElementById('upload-progress');
    const uploadProgressBar = document.getElementById('upload-progress-bar');
    const uploadPercent = document.getElementById('upload-percent');

    // ==================== ビデオアップロード処理 ====================
    uploadZone.addEventListener('click', () => videoInput.click());

    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('drag-over');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleVideoUpload(files[0]);
        }
    });

    videoInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleVideoUpload(e.target.files[0]);
        }
    });

    function handleVideoUpload(file) {
        if (!file.type.startsWith('video/')) {
            alert('Please select a valid video file');
            return;
        }

        const formData = new FormData();
        formData.append('video', file);

        state.isProcessing = true;
        uploadZone.style.opacity = '0.5';
        uploadProgress.classList.remove('hidden');

        // Simulate progress for better UX
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 10;
            if (progress <= 90) {
                uploadProgressBar.style.width = progress + '%';
                uploadPercent.textContent = progress + '%';
            }
        }, 200);

        fetch('/video/upload', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            clearInterval(progressInterval);
            uploadProgressBar.style.width = '100%';
            uploadPercent.textContent = '100%';

            if (data.status === 'success') {
                // 先頭に '/' を付けて保存（一貫性のため）
                state.videoPath = '/' + data.video_path;

                // Load video in player
                videoSource.src = state.videoPath;
                videoPlayer.load();

                setTimeout(() => {
                    showPlayerSection();
                    extractFrames();
                }, 500);
            } else {
                alert('Upload failed: ' + data.message);
            }
        })
        .catch(err => {
            clearInterval(progressInterval);
            alert('Error: ' + err.message);
        })
        .finally(() => {
            state.isProcessing = false;
            uploadZone.style.opacity = '1';
            setTimeout(() => {
                uploadProgress.classList.add('hidden');
                uploadProgressBar.style.width = '0%';
                uploadPercent.textContent = '0%';
            }, 1000);
        });
    }

    // ==================== フレーム抽出 ====================
    function extractFrames() {
        // バックエンドには先頭の'/'を除いたパスを送信
        const videoPathForBackend = state.videoPath.startsWith('/')
            ? state.videoPath.substring(1)
            : state.videoPath;

        fetch('/frames/extract', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ video_path: videoPathForBackend })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                state.frames = data.frames;
                renderFrames();
                if (state.frames.length > 0) {
                    selectFrame(0);
                }

                // 動画ソースを設定
                setVideoSource();
            } else {
                alert('Frame extraction failed: ' + data.message);
            }
        })
        .catch(err => alert('Error: ' + err.message));
    }

    // ==================== 動画ソース設定 ====================
    function setVideoSource() {
        if (!state.videoPath) {
            console.error('No video path set');
            return;
        }

        // 動画ソースを設定
        videoSource.src = state.videoPath;
        videoPlayer.load();

        console.log('Video source set to:', state.videoPath);
    }

    // === JavaScript: renderFrames を demoai スタイルに修正 ===
    function renderFrames() {
        framesContainer.innerHTML = '';
        state.frames.forEach((frame, index) => {
            const frameCard = document.createElement('div');
            // demoai のクラス名を使用
            frameCard.className = 'frame-card';
            frameCard.dataset.frameId = index;

            // 編集済みか確認
            const editedImageUrl = state.editedFrames[index];
            if (editedImageUrl) {
                frameCard.classList.add('edited');
                frameCard.style.backgroundImage = `url('${editedImageUrl}')`;
            } else {
                frameCard.style.backgroundImage = `url('${frame.base64}')`;
            }

            frameCard.addEventListener('click', () => selectFrame(index));
            
            // demoai スタイルのタイムスタンプを追加
            const frameNumber = document.createElement('div');
            frameNumber.className = 'frame-number';
            frameNumber.textContent = frame.timestamp;
            frameCard.appendChild(frameNumber);

            framesContainer.appendChild(frameCard);
        });
        
        // 選択状態を復元
        if (state.selectedFrame !== null) {
             document.querySelector(`[data-frame-id="${state.selectedFrame}"]`)?.classList.add('selected');
        }
    }

    // === JavaScript: selectFrame を demoai スタイルに修正 ===
    function selectFrame(frameId) {
        // demoai のクラス名を使用
        document.querySelectorAll('.frame-card.selected').forEach(el => {
            el.classList.remove('selected');
        });

        const newSelected = document.querySelector(`[data-frame-id="${frameId}"]`);
        if (newSelected) {
            newSelected.classList.add('selected');
        }

        state.selectedFrame = frameId;
        const frame = state.frames[frameId];
        
        // プレビューにも編集済み画像（あれば）を表示
        const imageUrl = state.editedFrames[frameId] || frame.base64;
        selectedFrameThumb.style.backgroundImage = `url('${imageUrl}')`;
        frameTimestamp.textContent = `Timestamp: ${frame.timestamp}`;

        // チャットをクリア
        chatContainer.innerHTML = '';
        state.selectedGeneratedImage = null;
    }

    // ==================== チャット機能 ====================
    sendBtn.addEventListener('click', () => sendMessage());
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        const text = chatInput.value.trim();
        if (!text || state.isProcessing || state.selectedFrame === null) return;

        addChatMessage('user', text);
        chatInput.value = '';
        state.isProcessing = true;
        sendBtn.disabled = true;

        // Add loading message
        const loadingId = addChatMessage('ai', 'Generating variations... Please wait.');

        fetch('/frames/edit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                frame_id: state.selectedFrame,
                prompt: text
            })
        })
        .then(res => res.json())
        .then(data => {
            // Remove loading message
            const loadingMsg = document.getElementById(loadingId);
            if (loadingMsg) loadingMsg.remove();

            if (data.status === 'success') {
                addChatMessage('ai', 'Here are a few options based on your request:', true, data.variations || []);
            } else {
                addChatMessage('ai', 'Error: ' + data.message);
            }
        })
        .catch(err => {
            const loadingMsg = document.getElementById(loadingId);
            if (loadingMsg) loadingMsg.remove();
            addChatMessage('ai', 'Error: ' + err.message);
        })
        .finally(() => {
            state.isProcessing = false;
            sendBtn.disabled = false;
        });
    }

    function addChatMessage(role, content, isResponse = false, variations = []) {
        const messageId = 'msg-' + Date.now();
        const messageDiv = document.createElement('div');
        messageDiv.id = messageId;
        messageDiv.className = 'flex gap-3 chat-message';

        if (role === 'user') {
            messageDiv.innerHTML = `
                <div class="size-8 rounded-full bg-[#667eea] flex-shrink-0 flex items-center justify-center text-white font-bold">U</div>
                <div class="p-3 rounded-lg bg-[#374151] rounded-tl-none">
                    <p class="text-gray-300 text-sm">"${content}"</p>
                </div>
            `;
        } else {
            let html = `
                <div class="size-8 rounded-full bg-[#34D399] flex-shrink-0 flex items-center justify-center">
                    <span class="material-symbols-outlined !text-xl text-black">auto_awesome</span>
                </div>
                <div class="p-3 rounded-lg bg-[#374151] rounded-bl-none flex-1">
                    <p class="text-gray-300 text-sm mb-3">${content}</p>
            `;

            if (isResponse && variations.length > 0) {
                html += '<div class="generated-image-grid">';
                variations.forEach((imgUrl, idx) => {
                    html += `
                        <div class="generated-image" data-image-id="${idx}" data-image-url="${imgUrl}" style="background-image: url('${imgUrl}');" title="Click to select"></div>
                    `;
                });
                html += '</div>';
            }

            html += '</div>';
            messageDiv.innerHTML = html;

            // 生成画像にクリックイベントを追加
            if (isResponse && variations.length > 0) {
                setTimeout(() => {
                    messageDiv.querySelectorAll('.generated-image').forEach(img => {
                        img.addEventListener('click', (e) => {
                            messageDiv.querySelectorAll('.generated-image').forEach(i => i.classList.remove('selected'));
                            e.target.classList.add('selected');
                            state.selectedGeneratedImage = e.target.dataset.imageUrl;

                            // Apply ボタンを表示
                            let applyBtn = messageDiv.querySelector('#apply-btn');
                            if (!applyBtn) {
                                applyBtn = document.createElement('button');
                                applyBtn.id = 'apply-btn';
                                applyBtn.className = 'w-full mt-2 py-2 px-4 bg-[#34D399] text-black text-sm font-bold rounded-lg hover:opacity-90 transition-opacity';
                                applyBtn.textContent = 'Apply to Frame';
                                applyBtn.addEventListener('click', applyFrameEdit);
                                messageDiv.querySelector('.flex-1').appendChild(applyBtn);
                            }
                        });
                    });
                }, 100);
            }
        }

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return messageId;
    }

    // === JavaScript: applyFrameEdit を demoai スタイルに修正 ===
    function applyFrameEdit() {
        if (!state.selectedGeneratedImage) return;

        fetch('/frames/apply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                frame_id: state.selectedFrame,
                edited_image_url: state.selectedGeneratedImage
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                addChatMessage('ai', '✓ Frame updated successfully!');
                
                // Mark as edited in state
                state.editedFrames[state.selectedFrame] = state.selectedGeneratedImage;
                
                // フレームサムネイルを更新 (demoai スタイル)
                const frameThumb = document.querySelector(`[data-frame-id="${state.selectedFrame}"]`);
                if (frameThumb) {
                    frameThumb.style.backgroundImage = `url('${state.selectedGeneratedImage}')`;
                    frameThumb.classList.add('edited'); // 'edited' クラスを追加
                }
                // プレビューを更新
                selectedFrameThumb.style.backgroundImage = `url('${state.selectedGeneratedImage}')`;
            }
        })
        .catch(err => alert('Error: ' + err.message));
    }

    // ==================== UI表示切り替え ====================
    function showPlayerSection() {
        uploadSection.classList.add('hidden');
        playerSection.classList.remove('hidden');
        editPanel.classList.remove('hidden');

        // 念のため、ここでも動画ソースを設定
        if (state.videoPath) {
            videoSource.src = state.videoPath;
            videoPlayer.load();
        }
    }

    resetVideoBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to upload a new video? All edits will be lost.')) {
            state.videoPath = null;
            state.frames = [];
            state.selectedFrame = null;
            state.editedFrames = {};
            uploadSection.classList.remove('hidden');
            playerSection.classList.add('hidden');
            editPanel.classList.add('hidden');
            videoInput.value = '';
            framesContainer.innerHTML = '';
            chatContainer.innerHTML = '';
        }
    });

    // ==================== エクスポート ====================
    exportBtn.addEventListener('click', () => {
        if (state.frames.length === 0) {
            alert('Please upload a video first');
            return;
        }

        if (Object.keys(state.editedFrames).length === 0) {
            alert('No frames have been edited yet');
            return;
        }

        exportBtn.disabled = true;
        exportBtn.innerHTML = '<span class="material-symbols-outlined mr-2 !text-base">hourglass_empty</span>Exporting...';

        fetch('/video/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.href = data.download_url;
            } else {
                alert('Export failed: ' + data.message);
            }
        })
        .catch(err => alert('Error: ' + err.message))
        .finally(() => {
            exportBtn.disabled = false;
            exportBtn.innerHTML = '<span class="material-symbols-outlined mr-2 !text-base">download</span>Export';
        });
    });
</script>
</body>
</html>