<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxury Property AI Video Generator</title>
    <!-- Load Poppins font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Load Material Symbols Outlined icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#34D399",
                        "background-light": "#F3F4F6",
                        "background-dark": "#121212",
                    },
                    fontFamily: {
                        display: ["Poppins", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
        }
        /* Progress bar animation */
        .progress-bar { transition: width 0.5s ease-in-out; }

        /* --- demoai/css/main.css からインポート --- */
        .upload-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }
        .upload-card .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .upload-card .description-text {
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .upload-card.uploaded {
            border-color: #34D399 !important;
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.05) 0%, rgba(52, 211, 153, 0.1) 100%);
        }
        .upload-card.uploaded::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: #34D399;
            color: black;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            animation: checkmark-pop 0.3s ease-out;
        }
        @keyframes checkmark-pop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        /* --- ここまで --- */
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200 antialiased">
    <div class="flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="w-full max-w-4xl mx-auto">
            <div class="text-center mb-10">
                <h1 class="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-white">Luxury Property AI Video Generator</h1>
                <p class="mt-4 text-lg text-gray-600 dark:text-gray-400">Upload 3 images of your property to automatically generate a stunning promotional video.</p>
            </div>

            <div class="bg-white dark:bg-gray-800/50 p-8 sm:p-10 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700">
                <div id="error-alert" class="hidden mb-6 p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-600 rounded-lg">
                    <p class="text-sm font-medium text-red-800 dark:text-red-300">Error: <span id="error-message"></span></p>
                </div>

                <form id="upload-form">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="upload-card flex flex-col items-center p-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-center">
                            <span class="material-symbols-outlined text-5xl text-gray-400 dark:text-gray-500 mb-3">home</span>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">Exterior View</h3>
                            <p class="description-text text-sm text-gray-500 dark:text-gray-400 mb-4">Building exterior and facade</p>
                            <label class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" for="image_1">
                                <span class="material-symbols-outlined text-base">upload_file</span>
                                Choose File
                            </label>
                            <input class="hidden" id="image_1" name="image_1" type="file" accept="image/png, image/jpeg" required>
                            <p id="filename_1" class="text-xs text-gray-500 dark:text-gray-400 mt-3 truncate w-full px-2 h-4"></p>
                        </div>
                        <div class="upload-card flex flex-col items-center p-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-center">
                            <span class="material-symbols-outlined text-5xl text-gray-400 dark:text-gray-500 mb-3">living</span>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">Interior Design</h3>
                            <p class="description-text text-sm text-gray-500 dark:text-gray-400 mb-4">Living spaces and rooms</p>
                            <label class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" for="image_2">
                                <span class="material-symbols-outlined text-base">upload_file</span>
                                Choose File
                            </label>
                            <input class="hidden" id="image_2" name="image_2" type="file" accept="image/png, image/jpeg" required>
                            <p id="filename_2" class="text-xs text-gray-500 dark:text-gray-400 mt-3 truncate w-full px-2 h-4"></p>
                        </div>
                        <div class="upload-card flex flex-col items-center p-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-center">
                            <span class="material-symbols-outlined text-5xl text-gray-400 dark:text-gray-500 mb-3">pool</span>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">Common Areas</h3>
                            <p class="description-text text-sm text-gray-500 dark:text-gray-400 mb-4">Lobby, amenities and facilities</p>
                            <label class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" for="image_3">
                                <span class="material-symbols-outlined text-base">upload_file</span>
                                Choose File
                            </label>
                            <input class="hidden" id="image_3" name="image_3" type="file" accept="image/png, image/jpeg" required>
                            <p id="filename_3" class="text-xs text-gray-500 dark:text-gray-400 mt-3 truncate w-full px-2 h-4"></p>
                        </div>
                    </div>

                    <button type="submit" id="upload-btn" class="hidden">Upload</button>
                </form>

                <div class="mt-10">
                    <div class="flex justify-between items-center mb-2">
                        <p id="status-message" class="text-sm font-medium text-gray-700 dark:text-gray-300">Upload Progress</p>
                        <p id="progress-text" class="text-sm font-medium text-gray-700 dark:text-gray-300">0%</p>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div id="progress-bar" class="progress-bar bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mt-10 pt-8 border-t border-gray-200 dark:border-gray-700">
                    <button id="generate-btn" disabled class="w-full bg-primary text-black font-bold text-lg py-4 px-6 rounded-lg flex items-center justify-center gap-3 hover:opacity-90 transition-opacity duration-300 focus:outline-none focus:ring-4 focus:ring-primary/50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="material-symbols-outlined">auto_awesome</span>
                        AI Video Generation Start
                    </button>

                    <button id="edit-now-btn" onclick="window.location.href='/video/editor'" class="w-full mt-3 bg-gray-600 dark:bg-[#374151] text-white font-bold text-lg py-4 px-6 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-700 dark:hover:bg-[#4b5563] transition-colors duration-300 focus:outline-none focus:ring-4 focus:ring-gray-500/50">
                        <span class="material-symbols-outlined">edit</span>
                        Edit Now
                    </button>
                </div>

                <div id="result-area" class="hidden mt-8 p-6 bg-primary/10 border-2 border-primary rounded-lg text-center">
                    <span class="material-symbols-outlined text-6xl text-primary mb-3">check_circle</span>
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Video Generation Complete!</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">Your stunning promotional video is ready.</p>

                    <div class="flex flex-col sm:flex-row gap-3 justify-center items-center">
                        <a id="download-link" href="/download" download="luxury_property_video.mp4" class="inline-flex items-center justify-center gap-2 py-3 px-8 bg-primary hover:opacity-90 text-black font-bold rounded-lg transition duration-200">
                            <span class="material-symbols-outlined">download</span>
                            Download Video
                        </a>
                        <button id="edit-frames-btn" class="inline-flex items-center justify-center gap-2 py-3 px-8 bg-gray-600 dark:bg-gray-700 hover:bg-gray-700 dark:hover:bg-gray-600 text-white font-bold rounded-lg transition duration-200">
                            <span class="material-symbols-outlined">edit</span>
                            Edit Frames
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM要素の取得
        const uploadForm = document.getElementById('upload-form');
        const uploadBtn = document.getElementById('upload-btn');
        const generateBtn = document.getElementById('generate-btn');
        const editNowBtn = document.getElementById('edit-now-btn');
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const resultArea = document.getElementById('result-area');
        const downloadLink = document.getElementById('download-link');
        const editFramesBtn = document.getElementById('edit-frames-btn');
        const errorAlert = document.getElementById('error-alert');
        const errorMessage = document.getElementById('error-message');
        
        // 処理中の状態フラグ
        let isProcessing = false;
        // ポーリングのインターバルID
        let pollInterval = null;

        // ファイル入力要素の取得
        const image1Input = document.getElementById('image_1');
        const image2Input = document.getElementById('image_2');
        const image3Input = document.getElementById('image_3');
        const filename1 = document.getElementById('filename_1');
        const filename2 = document.getElementById('filename_2');
        const filename3 = document.getElementById('filename_3');

        // --- UIヘルパー関数 ---
        function showError(message) {
            errorMessage.textContent = message;
            errorAlert.classList.remove('hidden');
        }

        function hideError() {
            errorAlert.classList.add('hidden');
            errorMessage.textContent = '';
        }

        // [MODIFIED] ファイル名表示とプログレス更新 + .uploaded クラスのトグル
        function updateFileDisplay(inputElement, displayElement) {
            const card = inputElement.closest('.upload-card'); // 親カードを取得
            if (inputElement.files.length > 0) {
                displayElement.textContent = inputElement.files[0].name;
                card.classList.add('uploaded'); // .uploaded クラスを追加
            } else {
                displayElement.textContent = '';
                card.classList.remove('uploaded'); // .uploaded クラスを削除
            }
            updateUploadProgress();
        }

        // アップロード進捗の計算（選択されたファイル数に基づく）
        function updateUploadProgress() {
            const filesSelected = [image1Input, image2Input, image3Input].filter(input => input.files.length > 0).length;
            const progress = (filesSelected / 3) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;

            // メッセージ更新
            if (filesSelected === 0) {
                statusMessage.textContent = 'Upload Progress';
            } else if (filesSelected < 3) {
                statusMessage.textContent = `${filesSelected}/3 images selected`;
            } else {
                statusMessage.textContent = 'Uploading images...';
            }

            // 3つ全て選択されたら自動的にアップロード
            if (filesSelected === 3 && !isProcessing) {
                // generateBtnを有効化 (demoaiの動作に合わせる)
                generateBtn.disabled = false;
                
                // 自動アップロードはコメントアウト (demoaiは手動生成開始のため)
                // setTimeout(() => {
                //     uploadForm.dispatchEvent(new Event('submit'));
                // }, 500);
            } else {
                 generateBtn.disabled = true;
            }
        }

        // ファイル選択イベントリスナーの追加
        image1Input.addEventListener('change', () => updateFileDisplay(image1Input, filename1));
        image2Input.addEventListener('change', () => updateFileDisplay(image2Input, filename2));
        image3Input.addEventListener('change', () => updateFileDisplay(image3Input, filename3));

        // [MODIFIED] updateStatusUI: .slide-in クラスの追加
        function updateStatusUI(status, message, percent, finalUrl = null) {
            statusMessage.textContent = message;
            // 進捗バーの更新
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${Math.round(percent)}%`;

            // ボタンの状態制御
            const isIdleOrComplete = (status === 'IDLE' || status === 'COMPLETE' || status === 'ERROR');

            // 処理中は、全てのボタンを無効化
            if (!isIdleOrComplete) {
                isProcessing = true;
                uploadBtn.disabled = true;
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<span class="material-symbols-outlined">hourglass_empty</span> Generating...';
            } else {
                isProcessing = false;
                uploadBtn.disabled = false;

                if (status === 'COMPLETE') {
                    // FIXED: Show result area with download button
                    resultArea.classList.remove('hidden');
                    resultArea.classList.add('slide-in');

                    // FIXED: Set download link href
                    if (finalUrl) {
                        downloadLink.href = finalUrl;
                    }

                    // Hide generate and edit now buttons on completion
                    generateBtn.style.display = 'none';
                    editNowBtn.style.display = 'none';
                } else if (status === 'ERROR') {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<span class="material-symbols-outlined">auto_awesome</span> AI Video Generation Start';
                    generateBtn.style.display = 'flex';
                    editNowBtn.style.display = 'flex';
                    resultArea.classList.add('hidden');
                    resultArea.classList.remove('slide-in');
                } else {
                    // IDLE状態
                    generateBtn.style.display = 'flex';
                    generateBtn.disabled = [image1Input, image2Input, image3Input].filter(input => input.files.length > 0).length !== 3;
                    generateBtn.innerHTML = '<span class="material-symbols-outlined">auto_awesome</span> AI Video Generation Start';
                    editNowBtn.style.display = 'flex';
                }
            }
        }
        
        // --- イベントリスナー ---
        
        // 1. 画像アップロード処理 (手動生成開始のため、自動送信を停止)
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // このフォームは自動送信や手動送信ボタン（id="upload-btn"）を持たないため、
            // 主に generateBtn のクリックがトリガーとなる。
            // 既存のJSでは `updateUploadProgress` 内で `filesSelected === 3` の際に
            // submit イベントを dispatch していたが、demoai に合わせるため
            // そのロジックを無効化し (updateUploadProgressでコメントアウト)、
            // /generate が /upload の役割も兼ねるようにする。
            
            // ... ただし、元のロジックでは /upload と /generate が分離していた。
            // バックエンドを変更しないという制約のため、
            // /upload の自動送信ロジックを `updateUploadProgress` に戻す。
            
             // 3つ全て選択されたら自動的にアップロード
            if ([image1Input, image2Input, image3Input].filter(input => input.files.length > 0).length === 3 && !isProcessing) {
                // 自動アップロードを実行
                if (isProcessing) return;

                hideError();
                updateStatusUI('UPLOADING', 'Uploading images...', 10);
                
                const formData = new FormData(uploadForm);
                
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (result.status === 'success') {
                        // アップロード成功: 処理を終了し、生成ボタンを有効化
                        updateStatusUI('IDLE', result.message, 0);
                        generateBtn.disabled = false; 
                    } else {
                        // Server-side error
                        showError(result.message);
                        updateStatusUI('ERROR', `Upload error occurred.`, 0);
                        generateBtn.disabled = true;
                    }
                } catch (error) {
                    // Network error, etc.
                    showError(`Network error: ${error.message}. Please check if the server is running.`);
                    updateStatusUI('ERROR', `Communication error occurred.`, 0);
                    generateBtn.disabled = true;
                }
            }
        });

        // updateUploadProgress のロジックを元に戻す（自動送信）
        function updateUploadProgress() {
            const filesSelected = [image1Input, image2Input, image3Input].filter(input => input.files.length > 0).length;
            const progress = (filesSelected / 3) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;

            // メッセージ更新
            if (filesSelected === 0) {
                statusMessage.textContent = 'Upload Progress';
            } else if (filesSelected < 3) {
                statusMessage.textContent = `${filesSelected}/3 images selected`;
            } else {
                statusMessage.textContent = 'Uploading images...';
            }

            // 3つ全て選択されたら自動的にアップロード
            if (filesSelected === 3 && !isProcessing) {
                 setTimeout(() => {
                     uploadForm.dispatchEvent(new Event('submit'));
                 }, 500);
            }
        }


        // 2. 動画生成開始処理
        generateBtn.addEventListener('click', async () => {
            if (isProcessing || generateBtn.disabled) return;

            hideError();
            // When generate-btn is pressed, enter processing state and update UI
            updateStatusUI('STARTING', 'Sending video generation request...', 15);

            try {
                const response = await fetch('/generate', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.status === 'complete') {
                    // FIXED: Handle immediate completion (synchronous generation)
                    updateStatusUI('COMPLETE', result.message, 100, result.final_video_url);
                } else if (result.status === 'started' || result.status === 'info') {
                    // Once generation starts, begin polling for status
                    updateStatusUI('GENERATING_CLIPS', result.message, 20);
                    startPolling();
                } else if (result.status === 'error') {
                    // Start failure (e.g., insufficient images, already in progress, etc.)
                    showError(result.message);
                    updateStatusUI('ERROR', `Failed to start generation.`, 0);
                } else {
                    // Unknown status
                    showError(result.message || 'Unknown error occurred');
                    updateStatusUI('ERROR', `Failed to start generation.`, 0);
                }
            } catch (error) {
                showError(`Network error: ${error.message}.`);
                updateStatusUI('ERROR', `Communication error occurred.`, 0);
            }
        });

        // --- Polling logic (progress check) ---
        function startPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            // Check status every 2 seconds
            pollInterval = setInterval(pollStatus, 2000);
        }

        async function pollStatus() {
            try {
                // *** Fixed: Changed fetch('/status') to new URL(...) ***
                const statusUrl = new URL('/status', window.location.href);
                const response = await fetch(statusUrl.toString());
                // *** End of fix ***

                const data = await response.json();

                if (data.status === 'ERROR') {
                    // On error
                    stopPolling();
                    showError(data.message);
                    updateStatusUI('ERROR', 'An error occurred during video generation.', data.progress_percent || 0);
                    // generateBtn.disabled = false; // demoaiではエラー時に再試行ボタンは表示されない
                } else if (data.status === 'COMPLETE') {
                    // On completion
                    stopPolling();
                    updateStatusUI(data.status, data.message, 100, data.final_video_url);
                    // generateBtn.disabled = false; // demoaiでは完了時に再試行ボタンは表示されない
                } else {
                    // In progress
                    const percent = data.progress_percent || 0;
                    updateStatusUI(data.status, data.message, percent, data.final_video_url);
                }

            } catch (error) {
                // Stop polling if communication error occurs (e.g., server down)
                console.error("Status API error:", error);
                // Continue polling unless it's a fatal error, as processing might still be ongoing
            }
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // FIXED: Edit Frames button handler
        if (editFramesBtn) {
            editFramesBtn.addEventListener('click', () => {
                window.location.href = '/video/editor';
            });
        }

        // Check status on initial load (load previous state if exists)
        window.onload = () => {
             // Synchronize UI state with server on initial poll
             pollStatus();
        };

        // Stop polling when page is closed
        window.onbeforeunload = stopPolling;

    </script>
</body>
</html>